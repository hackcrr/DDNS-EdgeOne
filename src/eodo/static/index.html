<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EdgeOne Dynamic Origin 控制台</title>
  <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
  <style>
    body { background: #f4f7fa; }
    .page-center { max-width: 800px; margin: 27px auto; }
    .tabler-logo {font-size: 1.6rem;font-weight:700;color:#206bc4;margin-bottom:22px;letter-spacing:0.03em;}
    #logs-modal-pre { min-height:170px; max-height:400px; overflow:auto; font-family:monospace; font-size:1.05em; background:#f7fafb; color: #222;}
    .mb-4 {margin-bottom:1.4rem;}
    .card-header {font-weight:bold;}
    .table thead th {background:#f4f6fb;}
    .table-vcenter td, .table-vcenter th {vertical-align:middle;}
    .card .card-body {padding-top: 1.1rem; padding-bottom:1.1rem;}
    .btn-del {padding:2px 10px;}
    .form-section-hd {font-size:1.12em;margin-bottom:7px;font-weight:600;}
  </style>
</head>
<body>
<div class="page page-center">
  <div class="tabler-logo text-center mb-3">EdgeOne Dynamic Origin 控制台</div>
  <!-- 状态卡片 -->
  <div class="card mb-4">
    <div class="card-header">
      <div class="card-title">服务状态</div>
    </div>
    <div class="card-body">
      <div id="status" class="mb-2">加载中...</div>
      <div>
        <button class="btn btn-blue" onclick="fetchStatus()">刷新状态</button>
        <button class="btn btn-outline-green m-1" onclick="runTask();">立即执行任务</button>
        <button class="btn btn-outline-secondary m-1" data-bs-toggle="modal" data-bs-target="#logModal" onclick="openLogModal()">
          查看日志
        </button>
      </div>
    </div>
  </div>

  <!-- 调度周期卡片 -->
  <div class="card mb-4">
    <div class="card-header">
      <div class="card-title">调度周期设置</div>
    </div>
    <div class="card-body">
      <div class="input-group w-50">
        <span class="input-group-text">周期(分钟)</span>
        <input type="number" id="interval" class="form-control" min="1" value="15">
        <button class="btn btn-primary" onclick="setIntervalM();">修改</button>
      </div>
    </div>
  </div>

  <!-- 创建加速域名 -->
  <div class="card mb-4">
    <div class="card-header">
      <span class="card-title">创建加速域名</span>
    </div>
    <div class="card-body">
      <form id="createAccelDomainForm" autocomplete="off">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label required">站点ZoneID</label>
            <select class="form-select" name="accelZoneId" id="accelZoneId" required></select>
            <div id="zoneIdFallback" class="mt-2">
              <input class="form-control" type="text" name="accelZoneIdCustom" id="accelZoneIdCustom" placeholder="手动输入ZoneID（当列表为空时）">
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">加速域名</label>
            <input class="form-control" type="text" name="accelDomainName" id="accelDomainName" required placeholder="例如：example.com">
          </div>
        </div>
        <div class="mb-3">
          <div class="form-label">源站配置（二选一）</div>
          <div class="d-flex gap-2 mb-2">
            <label class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="originType" value="group" checked>
              <span class="form-check-label">使用源站组</span>
            </label>
            <label class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="originType" value="direct">
              <span class="form-check-label">直接指定源站</span>
            </label>
          </div>
          <div id="originGroupDiv">
            <label class="form-label">源站组ID</label>
            <select class="form-select" name="originGroupId" id="originGroupId" placeholder="留空使用当前主机名对应的源站组">
              <option value="">留空使用当前主机名对应的源站组</option>
            </select>
            <div class="mt-1 text-sm text-muted" id="originGroupsLoading">请先选择ZoneID</div>
          </div>
          <div id="originDirectDiv" class="d-none">
            <label class="form-label">源站地址</label>
            <input class="form-control" type="text" name="originAddress" id="originAddress" placeholder="例如：1.1.1.1 或 example.com">
          </div>
          
          <!-- 回源配置 -->
          <div class="mt-3">
            <label class="form-label">回源协议</label>
            <select class="form-select" name="originProtocol" id="originProtocol">
              <option value="FOLLOW">协议跟随（FOLLOW）</option>
              <option value="HTTP">HTTP协议回源</option>
              <option value="HTTPS">HTTPS协议回源</option>
            </select>
          </div>
          
          <!-- IPv6状态配置 -->
          <div class="mt-3">
            <label class="form-label">IPv6状态</label>
            <select class="form-select" name="ipv6Status" id="ipv6Status">
              <option value="follow" selected>遵循站点IPv6配置</option>
              <option value="on">开启</option>
              <option value="off">关闭</option>
            </select>
          </div>
          
          <!-- 回源端口配置 -->
          <div id="httpPortDiv" class="mt-2">
            <label class="form-label">HTTP回源端口</label>
            <input class="form-control" type="number" name="httpOriginPort" id="httpOriginPort" min="1" max="65535" value="80" placeholder="默认为80">
          </div>
          <div id="httpsPortDiv" class="mt-2">
            <label class="form-label">HTTPS回源端口</label>
            <input class="form-control" type="number" name="httpsOriginPort" id="httpsOriginPort" min="1" max="65535" value="443" placeholder="默认为443">
          </div>
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-primary">创建加速域名</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 已创建加速域名列表 -->
  <div class="card mb-4">
    <div class="card-header">
      <span class="card-title">已创建加速域名列表</span>
    </div>
    <div class="card-body">
      <div class="mb-2">
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="fetchAccelDomains()">刷新列表</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="table table-vcenter table-striped table-bordered mb-3" id="AccelDomainsTable">
          <thead>
            <tr>
              <th>ZoneID</th>
              <th>加速域名</th>
              <th>源站配置</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 配置管理 -->
  <div class="card mb-4">
    <div class="card-header">
      <span class="card-title">配置管理</span>
    </div>
    <div class="card-body">
      <form id="configForm" autocomplete="off">
        <!-- 腾讯云密钥 -->
        <div class="form-section-hd">腾讯云密钥配置</div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label required">SecretId</label>
            <input class="form-control" type="text" name="SecretId" id="SecretId" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">SecretKey</label>
            <input class="form-control" type="password" name="SecretKey" id="SecretKey" required>
          </div>
        </div>
        <!-- EdgeOne站点配置 -->
        <div class="form-section-hd">EdgeOne 站点配置</div>
        <div class="mb-2">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEdgeOneRow()">增加站点</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="table table-vcenter table-bordered mb-3" id="EdgeOneTable">
            <thead>
              <tr>
                <th>ZoneID</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <!-- DnsPod记录配置 -->
        <div class="form-section-hd">DnsPod 记录配置</div>
        <div class="mb-2">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDnsRow()">增加记录</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="table table-vcenter table-striped table-bordered mb-3" id="DnsPodTable">
            <thead>
              <tr>
                <th>子域名</th>
                <th>记录类型</th>
                <th>主域名</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <!-- 钉钉机器人 -->
        <div class="form-section-hd">钉钉机器人配置</div>
        <div class="mb-3">
          <input class="form-control" type="text" name="DingTalkWebhook" id="DingTalkWebhook" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
        </div>
        <!-- IPv6地址显示/网络接口/提交 -->
        <div class="row">
          <div class="col-md-4 mb-2">
            <label class="form-label">当前网口IPv6地址</label>
            <select class="form-select" name="CurrentIPv6List" id="CurrentIPv6List" multiple></select>
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">选择网络接口</label>
            <select class="form-select" name="SelectIface" id="SelectIface"></select>
          </div>
          <div class="col-md-5 mb-2">
            <label class="form-label">最终IPv6地址</label>
            <select class="form-select" name="FinalIPv6Address" id="FinalIPv6Address" disabled></select>
          </div>
          <div class="col-md-5 mb-2">
            <label class="form-label">IPv6地址选择 (正则表达式或索引)</label>
            <input class="form-control" type="text" name="IPv6Regex" id="IPv6Regex" placeholder="@1/@2选择第1/2个地址，或使用正则表达式">
          </div>
          <div class="col-md-12 mb-2">
            <label class="form-label">自定义IP地址列表 (每行一个IP，支持IPv4和IPv6)</label>
            <textarea class="form-control" name="CustomIPList" id="CustomIPList" rows="3" placeholder="在此输入自定义IP地址，每行一个
例如：
192.168.1.1
2001:db8::1"></textarea>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-success" id="submitConfig">
              保存配置
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 日志模态窗口 -->
<div class="modal modal-blur fade" id="logModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">最近任务日志</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <pre id="logs-modal-pre">加载中...</pre>
        <div class="d-flex justify-content-between mt-1">
          <span></span>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="fetchLogsModal();">手动刷新</button>
            <button class="btn btn-outline-danger btn-sm" onclick="clearLogsModal();">清除日志</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast提示 -->
<div id="toast" style="
  display:none;position:fixed;left:50%;bottom:54px;min-width:160px;
  background:#206bc4;color:#fff;padding:14px 28px;
  border-radius:8px;z-index:10;font-size:1.08em;transform:translateX(-50%);
  box-shadow:0 2px 16px #206bc40a;letter-spacing:0.02em;">TOAST
</div>

<script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
<script>
// --- Toast ---
function showToast(msg, timeout=2200){
    let t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display="block";
    clearTimeout(t._hid);
    t._hid = setTimeout(()=>{t.style.display="none"}, timeout);
}

// 状态
function fetchStatus(){
    let dom = document.getElementById('status');
    dom.innerHTML = '<span class="text-muted">更新中...</span>';
    fetch('/api/status').then(r=>r.json()).then(res=>{
        let badgeClass = 'bg-secondary';
        if (res.result === '异常') {
            badgeClass = 'bg-danger';
        } else if (res.result === '结束') {
            badgeClass = 'bg-success';
        } else if (res.result === '跳过') {
            badgeClass = 'bg-info';
        } else if (res.result === '启动') {
            badgeClass = 'bg-warning';
        }
        dom.innerHTML = `
            <b>任务ID:</b> ${res.id||'未知'}<br>
            <b>任务时间:</b> ${res.time||''}<br>
            <b>状态:</b> <span class="badge ${badgeClass}">
            ${res.result||'未知'}</span>
        `;
    }).catch(()=>{ dom.innerHTML = '<span class="text-danger">获取失败</span>'; });
}

// 周期
function setIntervalM(){
    let v = Number(document.getElementById('interval').value);
    document.getElementById('interval').disabled = true;
    fetch('/api/interval', {method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({interval:v})})
        .then(res=>res.json()).then(d=>{
            showToast(d.msg||"设置完成");
            document.getElementById('interval').disabled = false;
            fetchConfig();
        })
        .catch(()=>{
            showToast("设置失败",2500);
            document.getElementById('interval').disabled = false;
        });
}
// ------ EdgeOne 配置 表格
function addEdgeOneRow(val="") {
  let tb = document.getElementById("EdgeOneTable").getElementsByTagName("tbody")[0];
  let tr = tb.insertRow();
  let td0 = tr.insertCell(); td0.innerHTML = `<input type="text" class="form-control" value="${val}">`;
  let td1 = tr.insertCell(); td1.innerHTML = `<button type="button" class="btn btn-link text-danger btn-del" onclick="this.closest('tr').remove()">移除</button>`;
}
function setEdgeOneTable(arr) {
  let tb = document.getElementById("EdgeOneTable").getElementsByTagName("tbody")[0];
  tb.innerHTML = "";
  (arr||[]).forEach(val=>addEdgeOneRow(val));
  
  // 更新ZoneID选择器
  updateZoneIdSelector();
}

// 更新ZoneID选择器
function updateZoneIdSelector() {
  const zoneIds = getEdgeOneZoneArr();
  const select = document.getElementById('accelZoneId');
  const fallbackDiv = document.getElementById('zoneIdFallback');
  
  // 清空选择器
  select.innerHTML = '';
  
  if (zoneIds.length > 0) {
    // 有多个ZoneID时显示选择器
    select.style.display = 'block';
    fallbackDiv.style.display = 'none';
    
    // 添加选项
    zoneIds.forEach(zoneId => {
      const option = document.createElement('option');
      option.value = zoneId;
      option.textContent = zoneId;
      select.appendChild(option);
    });
    
    // 如果有默认选中的ZoneID，自动获取源站组列表
    if (select.value) {
      fetchOriginGroups(select.value);
    }
  } else {
    // 没有ZoneID时隐藏选择器，显示输入框
    select.style.display = 'none';
    fallbackDiv.style.display = 'block';
    
    // 清空源站组选择器
    const originGroupSelect = document.getElementById('originGroupId');
    const loadingText = document.getElementById('originGroupsLoading');
    originGroupSelect.innerHTML = '<option value="">留空使用当前主机名对应的源站组</option>';
    loadingText.textContent = '请先选择ZoneID';
  }
}
function getEdgeOneZoneArr() {
  let tb = document.getElementById("EdgeOneTable").getElementsByTagName("tbody")[0];
  return Array.from(tb.querySelectorAll("tr")).map(tr=>tr.cells[0].querySelector("input").value.trim()).filter(Boolean);
}

// ------ DnsPod 配置 表格
function addDnsRow(sub="",typ="AAAA",root="") {
  let tb = document.getElementById("DnsPodTable").getElementsByTagName("tbody")[0];
  let tr = tb.insertRow();
  tr.insertCell().innerHTML = `<input type="text" class="form-control" value="${sub}">`;
  tr.insertCell().innerHTML = `<select class="form-select" disabled><option value="AAAA">AAAA</option></select>`;
  tr.insertCell().innerHTML = `<input type="text" class="form-control" value="${root}">`;
  tr.insertCell().innerHTML = `<button type="button" class="btn btn-link text-danger btn-del" onclick="this.closest('tr').remove()">移除</button>`;
}
function setDnsPodTable(arr) {
  let tb = document.getElementById("DnsPodTable").getElementsByTagName("tbody")[0];
  tb.innerHTML = "";
  (arr||[]).forEach(str=>{
    let [sub,type,root] = (str+"||").split("|");
    addDnsRow(sub, "AAAA", root||"");
  });
}
function getDnsPodRecordArr() {
  let tb = document.getElementById("DnsPodTable").getElementsByTagName("tbody")[0];
  return Array.from(tb.querySelectorAll("tr"))
      .map(tr=>{
        let sub = tr.cells[0].querySelector("input").value.trim();
        let typ = "AAAA";
        let root = tr.cells[2].querySelector("input").value.trim();
        return sub && root ? `${sub}|${typ}|${root}` : null;
      }).filter(Boolean);
}

// ----  配置  ----
function fetchConfig(){
    fetch('/api/config').then(r=>r.json()).then(res=>{
        document.getElementById('SecretId').value = res?.TencentCloud?.SecretId||"";
        document.getElementById('SecretKey').value = res?.TencentCloud?.SecretKey||"";
        setEdgeOneTable(Array.isArray(res?.EdgeOneZoneId) ? res.EdgeOneZoneId : (typeof res.EdgeOneZoneId==="string"?[res.EdgeOneZoneId] : []));
        setDnsPodTable(Array.isArray(res?.DnsPodRecord) ? res.DnsPodRecord : (typeof res.DnsPodRecord==="string"?[res.DnsPodRecord] : []));
        document.getElementById('DingTalkWebhook').value = res?.DingTalkWebhook||"";
        if(res.IntervalMin) document.getElementById('interval').value = res.IntervalMin;
        fetch('/api/iface').then(r=>r.json()).then(ifaces=>{
            let sel = document.getElementById('SelectIface');
            sel.innerHTML = "";
            // 确保ifaces是数组类型
            const ifacesArray = Array.isArray(ifaces) ? ifaces : [];
            ifacesArray.forEach(i=>{
                let o = document.createElement('option');
                o.value = o.textContent = i;
                if(res.SelectIface==i)o.selected=true;
                sel.appendChild(o);
            });
            
            // 初始化后获取IPv6地址
            if(sel.value) {
                fetchIPv6Addresses(sel.value, res?.IPv6Regex||"");
            }
            
            // 添加接口切换事件监听
            sel.onchange = function() {
                fetchIPv6Addresses(this.value, document.getElementById('IPv6Regex').value);
            };
        });
        document.getElementById('IPv6Regex').value = res?.IPv6Regex||"";
        
        // 加载自定义IP列表，将数组转换为多行文本
        if(Array.isArray(res?.CustomIPList) && res.CustomIPList.length > 0) {
            document.getElementById('CustomIPList').value = res.CustomIPList.join('\n');
        } else {
            document.getElementById('CustomIPList').value = '';
        }
        
        // 添加IPv6Regex输入变化事件
        document.getElementById('IPv6Regex').oninput = function() {
            const iface = document.getElementById('SelectIface').value;
            if(iface) {
                fetchIPv6Addresses(iface, this.value);
            }
        };
    }).catch(()=>{showToast("配置加载失败",2200);});
}

// 获取并更新IPv6地址列表
function fetchIPv6Addresses(iface, ipv6Regex) {
    fetch(`/api/ipv6-addresses?iface=${encodeURIComponent(iface)}`)
        .then(r=>r.json())
        .then(addresses=>{
            // 更新当前网口IPv6地址选择框（多选）
            const ipv6ListSelect = document.getElementById('CurrentIPv6List');
            ipv6ListSelect.innerHTML = "";
            
            if(addresses.length > 0) {
                addresses.forEach(addr=>{
                    let option = document.createElement('option');
                    option.value = option.textContent = addr;
                    ipv6ListSelect.appendChild(option);
                });
                
                // 设置多选下拉框的大小，确保能看到多个地址
                ipv6ListSelect.size = Math.min(addresses.length, 5);
                
                // 根据IPv6Regex选择最终地址
                updateFinalIPv6Address(addresses, ipv6Regex);
            } else {
                let option = document.createElement('option');
                option.value = "";
                option.textContent = "未发现IPv6地址";
                ipv6ListSelect.appendChild(option);
                ipv6ListSelect.size = 1;
                
                // 清空最终IPv6地址选择框
                const finalSelect = document.getElementById('FinalIPv6Address');
                finalSelect.innerHTML = "";
                option = document.createElement('option');
                option.value = "";
                option.textContent = "未选择IPv6地址";
                finalSelect.appendChild(option);
            }
        })
        .catch(()=>{
            showToast("获取IPv6地址失败",2200);
        });
}

// 根据正则表达式或索引选择最终IPv6地址
function updateFinalIPv6Address(addresses, ipv6Regex) {
    const finalSelect = document.getElementById('FinalIPv6Address');
    finalSelect.innerHTML = "";
    
    let selectedAddr = null;
    
    if(ipv6Regex) {
        // 处理索引格式 @1, @2 等
        if(ipv6Regex.startsWith('@')) {
            const index = parseInt(ipv6Regex.substring(1)) - 1;
            if(!isNaN(index) && index >= 0 && index < addresses.length) {
                selectedAddr = addresses[index];
            }
        } else {
            // 处理正则表达式
            try {
                const regex = new RegExp(ipv6Regex);
                selectedAddr = addresses.find(addr => regex.test(addr));
            } catch(e) {
                // 正则表达式无效，忽略
            }
        }
    }
    
    // 如果没有匹配的地址，使用第一个地址
    if(!selectedAddr && addresses.length > 0) {
        selectedAddr = addresses[0];
    }
    
    if(selectedAddr) {
        let option = document.createElement('option');
        option.value = option.textContent = selectedAddr;
        option.selected = true;
        finalSelect.appendChild(option);
    } else {
        let option = document.createElement('option');
        option.value = "";
        option.textContent = "未找到匹配的IPv6地址";
        finalSelect.appendChild(option);
    }
}
document.getElementById('configForm').onsubmit = function(e){
    e.preventDefault();
    // 处理自定义IP列表，按行分割并过滤空行
    const customIPs = this.CustomIPList.value.split('\n')
      .map(ip => ip.trim())
      .filter(ip => ip);
    
    let data = {
      TencentCloud: {
        SecretId: this.SecretId.value.trim(),
        SecretKey: this.SecretKey.value.trim()
      },
      EdgeOneZoneId: getEdgeOneZoneArr(),
      DnsPodRecord: getDnsPodRecordArr(),
      DingTalkWebhook: this.DingTalkWebhook.value.trim(),
      SelectIface: this.SelectIface.value,
      IPv6Regex: this.IPv6Regex.value.trim(),
      CustomIPList: customIPs,
      IntervalMin: Number(document.getElementById('interval').value)||15
    };
    document.getElementById('submitConfig').disabled = true;
    fetch('/api/config', {
        method: "POST", headers: {"content-type":"application/json"},
        body: JSON.stringify(data)
      }).then(r=>r.json()).then(d=>{
         showToast(d.msg||"配置已保存");
         fetchConfig();
         document.getElementById('submitConfig').disabled = false;
      }).catch(()=>{
         showToast("提交失败",2300);
         document.getElementById('submitConfig').disabled = false;
      });
};
// ---- 日志模态 ----
function fetchLogsModal(){    
    let logsdom = document.getElementById('logs-modal-pre');
    logsdom.textContent = "加载中...";
    fetch('/api/logs').then(r=>r.json()).then(res=>{
        logsdom.textContent = res.logs||"无日志";
    }).catch(()=>{logsdom.textContent="日志加载失败";});
}

// 清除日志
function clearLogsModal(){
    let logsdom = document.getElementById('logs-modal-pre');
    logsdom.textContent = "日志已清除";
    showToast("日志已清除");
}
function openLogModal(){
    fetchLogsModal();
    if(openLogModal._timer) clearInterval(openLogModal._timer);
    openLogModal._timer = setInterval(fetchLogsModal, 9000);
    let modal = document.getElementById('logModal');
    modal.addEventListener('hidden.bs.modal', ()=>{
        if(openLogModal._timer){ clearInterval(openLogModal._timer); openLogModal._timer = null; }
    }, {once: true});
}

// ---- 创建加速域名
function setupAccelDomainForm() {
    // 初始化ZoneID选择器
    updateZoneIdSelector();
    
    // 源站类型切换
    const originTypeRadios = document.querySelectorAll('input[name="originType"]');
    const groupDiv = document.getElementById('originGroupDiv');
    const directDiv = document.getElementById('originDirectDiv');
    const originGroupInput = document.getElementById('originGroupId');
    const originAddressInput = document.getElementById('originAddress');
    
    function updateOriginFields() {
        const selectedType = document.querySelector('input[name="originType"]:checked').value;
        
        if (selectedType === 'group') {
            groupDiv.classList.remove('d-none');
            directDiv.classList.add('d-none');
            originGroupInput.removeAttribute('disabled');
            originAddressInput.setAttribute('disabled', 'disabled');
        } else {
            groupDiv.classList.add('d-none');
            directDiv.classList.remove('d-none');
            originGroupInput.setAttribute('disabled', 'disabled');
            originAddressInput.removeAttribute('disabled');
        }
    }
    
    originTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateOriginFields);
    });
    
    updateOriginFields();
    
    // 监听ZoneID变化，更新源站组列表
    const zoneIdSelect = document.getElementById('accelZoneId');
    const zoneIdCustom = document.getElementById('accelZoneIdCustom');
    
    if (zoneIdSelect) {
      zoneIdSelect.addEventListener('change', function() {
        if (this.value.trim()) {
          fetchOriginGroups(this.value.trim());
        }
      });
    }
    
    if (zoneIdCustom) {
      zoneIdCustom.addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
          fetchOriginGroups(value);
        } else {
          const select = document.getElementById('originGroupId');
          const loadingText = document.getElementById('originGroupsLoading');
          select.innerHTML = '<option value="">留空使用当前主机名对应的源站组</option>';
          loadingText.textContent = '请先选择ZoneID';
        }
      });
    }
    
    // 回源协议选择器事件监听
    document.getElementById('originProtocol').addEventListener('change', function() {
      const protocol = this.value;
      const httpPortDiv = document.getElementById('httpPortDiv');
      const httpsPortDiv = document.getElementById('httpsPortDiv');
      
      if (protocol === 'FOLLOW') {
        // 协议跟随：显示两个端口
        httpPortDiv.classList.remove('d-none');
        httpsPortDiv.classList.remove('d-none');
      } else if (protocol === 'HTTP') {
        // HTTP协议：只显示HTTP端口
        httpPortDiv.classList.remove('d-none');
        httpsPortDiv.classList.add('d-none');
      } else if (protocol === 'HTTPS') {
        // HTTPS协议：只显示HTTPS端口
        httpPortDiv.classList.add('d-none');
        httpsPortDiv.classList.remove('d-none');
      }
    });
    
    // 初始加载时触发一次，确保端口显示正确
    document.getElementById('originProtocol').dispatchEvent(new Event('change'));
    
    // 表单提交
    document.getElementById('createAccelDomainForm').onsubmit = function(e) {
        e.preventDefault();
        
        // 获取ZoneID（从选择器或手动输入中）
        let zoneId = '';
        const select = document.getElementById('accelZoneId');
        const customInput = document.getElementById('accelZoneIdCustom');
        
        if (select.style.display !== 'none') {
          zoneId = select.value.trim();
        } else {
          zoneId = customInput.value.trim();
        }
        
        const domainName = this.accelDomainName.value.trim();
        
        if (!zoneId || !domainName) {
            showToast('请填写必填字段', 2000);
            return;
        }
        
        const originType = document.querySelector('input[name="originType"]:checked').value;
        let data = {
            zoneId: zoneId,
            domainName: domainName,
            originType: originType
        };
        
        if (originType === 'group') {
            const originGroupSelect = document.getElementById('originGroupId');
            const selectedOption = originGroupSelect.options[originGroupSelect.selectedIndex];
            const groupId = selectedOption ? selectedOption.value.trim() : '';
            
            if (groupId) {
                console.log('选择的源站组ID:', groupId, typeof groupId);
                data.originGroupId = groupId;
            }
        } else {
            const originAddr = this.originAddress.value.trim();
            if (!originAddr) {
                showToast('请填写源站地址', 2000);
                return;
            }
            data.originAddress = originAddr;
        }
        
        // 添加回源配置
        const originProtocol = this.originProtocol.value;
        data.originProtocol = originProtocol;
        
        // 添加IPv6状态配置
        const ipv6Status = this.ipv6Status.value;
        data.ipv6Status = ipv6Status;
        
        // 根据协议添加对应的端口
        if (originProtocol === 'FOLLOW' || originProtocol === 'HTTP') {
            data.httpOriginPort = parseInt(this.httpOriginPort.value) || 80;
        }
        
        if (originProtocol === 'FOLLOW' || originProtocol === 'HTTPS') {
            data.httpsOriginPort = parseInt(this.httpsOriginPort.value) || 443;
        }
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '处理中...';
        
        // 显示加速域名创建提示
        showToast('正在创建加速域名，请稍候...', 3000);
        
        // 调用后端API创建加速域名
        fetch('/api/create-accel-domain', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP错误! 状态码: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // 先显示加速域名创建成功
                showToast('加速域名创建成功', 2000);
                
                // 检查是否有DNS记录创建警告
                if (result.warning) {
                    // 显示警告信息
                    setTimeout(() => {
                        showToast(result.message || 'DNS记录创建失败，请手动配置', 5000, 'warning');
                    }, 2000);
                } else {
                    // 正常情况下，显示DNS记录创建进度
                    setTimeout(() => {
                        showToast('正在创建DNS记录，请稍候...', 3000);
                    }, 2000);
                }
                
                // 重置表单
                this.reset();
                // 刷新加速域名列表
                fetchAccelDomains();
            } else {
                // 显示错误信息
                showToast(`创建失败: ${result.message || '未知错误'}`, 3000);
            }
        })
        .catch(error => {
            showToast(`请求失败: ${error.message || '请稍后重试'}`, 3000);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = '创建加速域名';
        });
    };
}
// ---- 加速域名列表管理
function addAccelDomainRow(zoneId, domainName, originConfig) {
  let tb = document.getElementById("AccelDomainsTable").getElementsByTagName("tbody")[0];
  let tr = tb.insertRow();
  tr.insertCell().innerHTML = `<input type="text" class="form-control" value="${zoneId}" readonly>`;
  tr.insertCell().innerHTML = `<input type="text" class="form-control" value="${domainName}" readonly>`;
  tr.insertCell().innerHTML = `<input type="text" class="form-control" value="${originConfig}" readonly>`;
  tr.insertCell().innerHTML = `<button type="button" class="btn btn-link text-danger btn-del" onclick="deleteAccelDomain('${zoneId}', '${domainName}', this)">移除</button>`;
}

// 删除加速域名
function deleteAccelDomain(zoneId, domainName, btn) {
  if (!confirm(`确定要删除加速域名 ${domainName} 吗？`)) {
    return;
  }
  
  btn.disabled = true;
  btn.textContent = '删除中...';
  
  fetch('/api/delete-accel-domain', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ zoneId: zoneId, domainName: domainName })
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast('删除成功', 2000);
      // 从表格中移除该行
      btn.closest('tr').remove();
    } else {
      showToast(`删除失败: ${result.message || '未知错误'}`, 3000);
    }
  })
  .catch(error => {
    showToast('请求失败，请稍后重试', 2000);
  })
  .finally(() => {
    btn.disabled = false;
    btn.textContent = '移除';
  });
}

function setAccelDomainsTable(domains) {
  let tb = document.getElementById("AccelDomainsTable").getElementsByTagName("tbody")[0];
  tb.innerHTML = "";
  (domains||[]).forEach(domain => {
    // 格式化源站配置显示
    let originConfig = '';
    if (domain.originGroupId) {
      originConfig = `源站组: ${domain.originGroupId}`;
    } else if (domain.originAddress) {
      originConfig = `直接源站: ${domain.originAddress}`;
    } else {
      originConfig = '默认源站组';
    }
    
    // 添加回源协议和端口信息
    if (domain.originProtocol) {
      originConfig += `, 协议: ${domain.originProtocol}`;
      
      // 根据协议添加对应的端口
      if (domain.originProtocol === 'FOLLOW' || domain.originProtocol === 'HTTP') {
        originConfig += `, HTTP端口: ${domain.httpOriginPort || 80}`;
      }
      
      if (domain.originProtocol === 'FOLLOW' || domain.originProtocol === 'HTTPS') {
        originConfig += `, HTTPS端口: ${domain.httpsOriginPort || 443}`;
      }
    }
    
    addAccelDomainRow(domain.zoneId, domain.domainName, originConfig);
  });
}

// 获取源站组列表
function fetchOriginGroups(zoneId) {
  const select = document.getElementById('originGroupId');
  const loadingText = document.getElementById('originGroupsLoading');
  
  // 清空并禁用选择器，显示加载状态
  select.innerHTML = '<option value="">加载中...</option>';
  select.disabled = true;
  loadingText.textContent = '加载源站组列表中...';
  
  // 调用API获取源站组列表
  fetch(`/api/origin-groups/${encodeURIComponent(zoneId)}`)
    .then(response => response.json())
    .then(result => {
      select.innerHTML = '<option value="">留空使用当前主机名对应的源站组</option>';
      select.disabled = false;
      loadingText.textContent = '';
      
      if (result.success) {
        if (result.originGroups && result.originGroups.length > 0) {
          result.originGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.groupId;
            option.textContent = `${group.name} (${group.type || group.groupId})`;
            select.appendChild(option);
          });
        } else {
          loadingText.textContent = '该ZoneID下无可用源站组';
        }
      } else {
        // 使用后端返回的统一错误提示
        loadingText.textContent = result.message || '获取源站组列表失败';
        showToast(loadingText.textContent, 3000);
      }
    })
    .catch(error => {
      select.innerHTML = '<option value="">留空使用当前主机名对应的源站组</option>';
      select.disabled = false;
      const errorMsg = '获取源站组列表失败，请检查SecretId、SecretKey和EdgeOne站点配置的ZoneID是否正确';
      loadingText.textContent = errorMsg;
      showToast(errorMsg, 3000);
    });
}

function fetchAccelDomains() {
  // 显示加载状态
  let tb = document.getElementById("AccelDomainsTable").getElementsByTagName("tbody")[0];
  tb.innerHTML = '<tr><td colspan="4" class="text-center">加载中...</td></tr>';
  
  // 调用API获取加速域名列表
  fetch('/api/accel-domains')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        setAccelDomainsTable(data.domains || []);
        if (!data.domains || data.domains.length === 0) {
          tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无加速域名</td></tr>';
        }
      } else {
        showToast(`获取加速域名列表失败: ${data.message || '未知错误'}`, 2000);
        tb.innerHTML = '<tr><td colspan="4" class="text-center text-danger">获取失败，请重试</td></tr>';
      }
    })
    .catch(error => {
      showToast('网络请求失败，请稍后重试', 2000);
      tb.innerHTML = '<tr><td colspan="4" class="text-center text-danger">网络错误，请重试</td></tr>';
    });
}

// ---- runTask
function runTask(){
    showToast("任务启动中...");
    fetch('/api/run-task', {method:"POST"}).then(_=>{
        fetchStatus();
        showToast("任务已触发，请稍后查看结果。");
    }).catch(()=>{showToast("执行失败",2500);});
}
window.onload = function(){
    fetchStatus();
    fetchConfig();
    setupAccelDomainForm();
    fetchAccelDomains(); // 初始化加速域名列表
    setInterval(()=>fetchStatus(), 60000); // 每1分钟轮询一次
}
</script>
</body>
</html>